# API Specification: D-PC Federation Hub v1.0

**Version:** 1.0
**Status:** Proposal for MVP 2.0
**Date:** November 2, 2025

## 1. General Principles

-   **Architecture:** RESTful API
-   **Data Format:** JSON (UTF-8)
-   **Authentication:** All endpoints (except for the `/auth` flow) require an `Authorization: Bearer <JWT_TOKEN>` header.
-   **Base URL:** `https://hub.dpc.network/api/v1` (example)

## 2. Authentication Flow (OAuth 2.0)

The Hub does not manage passwords. Authentication is handled via trusted third-party providers like Google or GitHub.

1.  **`GET /auth/login/{provider}`**
    -   **Description:** Initiates the OAuth 2.0 login flow.
    -   **Path Parameters:** `provider` (string, required): `google` or `github`.
    -   **Action:** Redirects the user's browser to the provider's authentication page.

2.  **`GET /auth/callback/{provider}`**
    -   **Description:** The callback URL that the provider redirects to after successful authentication.
    -   **Action:** The Hub server exchanges the received code for an access token from the provider, identifies the user, creates an account if one doesn't exist, and generates a short-lived D-PC Hub JWT.
    -   **Response:** Redirects the user back to the client application with the JWT (e.g., in a query parameter).

## 3. Profile Management

These endpoints manage the user's **publicly visible profile** on the Hub. This data is a filtered subset of the user's full local context.

1.  **`PUT /profile`**
    -   **Description:** Creates or completely updates the user's public profile on the Hub. This should be called after login and whenever the user updates their public-facing context.
    -   **Authentication:** Required.
    -   **Request Body (JSON):** The filtered public profile generated by the local client.
        ```json
        {
          "node_id": "dpc-node-8b066c7f3d7eb627",
          "name": "Alice",
          "description": "AI Researcher focused on NLP.",
          "expertise": {
            "natural_language_processing": 5,
            "python": 4,
            "game_development": 2
          },
          "compute": {
            "policy": "friends_only",
            "models": ["llama3.1:70b-instruct-q4"]
          },
          "p2p_uri_hint": "dpc://<last_known_ip>:<port>?node_id=..."
        }
        ```
    -   **Response:** `200 OK` on success.

2.  **`GET /profile/{node_id}`**
    -   **Description:** Retrieves the full public profile for a given `node_id`.
    -   **Authentication:** Required.
    -   **Path Parameters:** `node_id` (string, required).
    -   **Response:** `200 OK` with the profile JSON object.

3.  **`DELETE /profile`**
    -   **Description:** Deletes the user's account and all associated data from the Hub.
    -   **Authentication:** Required.
    -   **Response:** `204 No Content` on success.

## 4. Discovery API

This allows clients to find other users on the network.

1.  **`GET /discovery/search`**
    -   **Description:** Searches for users based on their expertise.
    -   **Authentication:** Required.
    -   **Query Parameters:**
        -   `q` (string, required): The topic or skill to search for (e.g., `python`, `game_development`).
        -   `min_level` (integer, optional): The minimum proficiency level (1-5).
    -   **Response:** `200 OK` with a list of matching users. The profiles in the response are abbreviated for efficiency.
        ```json
        {
          "results": [
            {
              "node_id": "dpc-node-f49f00a0379b669a",
              "name": "Bob",
              "description": "Game developer with a focus on rendering pipelines."
            }
          ]
        }
        ```

## 5. Signaling API (for P2P Connection Setup)

This is a WebSocket endpoint used to broker the initial handshake for a direct P2P connection, enabling NAT traversal.

-   **Endpoint:** `WebSocket /ws/signal`

-   **Connection:**
    -   Client connects to the WebSocket endpoint.
    -   Immediately after connecting, the client must send an authentication message:
        ```json
        {
          "type": "auth",
          "token": "<JWT_TOKEN>"
        }
        ```

-   **Message Flow:**
    The server acts as a simple message relay. It does not interpret the `payload`.
    1.  **Alice (Initiator)** sends:
        ```json
        {
          "type": "signal",
          "target_node_id": "dpc-node-boris-xyz",
          "payload": {
            "type": "offer",
            "sdp": "..." // WebRTC Session Description Protocol
          }
        }
        ```
    2.  **The Hub Server** receives this message, looks up the WebSocket connection for `dpc-node-boris-xyz`, and forwards the entire message to **Bob**.
    3.  **Bob** receives the offer and sends back an answer:
        ```json
        {
          "type": "signal",
          "target_node_id": "dpc-node-alice-xyz",
          "payload": {
            "type": "answer",
            "sdp": "..."
          }
        }
        ```
    4.  This process continues with `ice-candidate` messages until a direct P2P channel is established.
    5.  Once the P2P connection is live, the clients can disconnect from the WebSocket or keep it for presence notifications. The Hub is no longer involved in their communication.